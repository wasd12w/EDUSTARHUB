<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EDUSTARHUB - GCSE Success</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary-purple: #6b46c1; --secondary-pink: #d946ef; --dashboard-bg: #f7fafc; }
    body { font-family: 'Inter', sans-serif; background-color: var(--dashboard-bg); }
    .landing-gradient { background: linear-gradient(135deg, #a78bfa 0%, #d946ef 100%); }
    .btn-primary { background-color: var(--secondary-pink); transition: background-color 0.2s; }
    .btn-primary:hover { background: #c026d3; }
    .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    @media (min-width: 1024px) { .dashboard-grid { grid-template-columns: 300px 1fr; } }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .interactive-card { cursor: pointer; transition: transform .2s, box-shadow .2s; }
    .interactive-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05); }
  </style>
</head>
<body class="min-h-screen">
  <div id="app" class="relative">

    <!-- Landing -->
    <section id="view-landing" data-view="landing" class="landing-gradient min-h-screen p-4 lg:p-12 hidden">
      <header class="flex justify-between items-center text-white">
        <div class="text-2xl font-extrabold tracking-tight">EDUSTARHUB</div>
        <button onclick="changeView('login')" class="bg-white text-violet-700 font-bold py-2 px-4 rounded-lg shadow-md">Get Started</button>
      </header>

      <div class="flex flex-col lg:flex-row items-center justify-between mt-16 lg:mt-24 max-w-7xl mx-auto">
        <div class="lg:w-1/2 text-white">
          <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold leading-tight">Master Your GCSEs.</h1>
          <p class="mt-4 text-lg text-gray-200 max-w-md">Your central hub for high-quality, curated resources and personalised learning plans for GCSEs.</p>
          <div class="mt-8">
            <button onclick="changeView('login')" class="btn-primary text-white font-bold py-3 px-8 rounded-xl text-lg">Start Learning Now</button>
            <p class="mt-2 text-sm text-gray-200">Trusted by thousands of GCSE students.</p>
          </div>
        </div>

        <div class="lg:w-1/2 mt-12 lg:mt-0 flex justify-center relative">
          <div class="w-full max-w-lg h-80 bg-violet-900 bg-opacity-30 rounded-3xl shadow-2xl flex items-center justify-center p-6">
            <span class="absolute text-xl font-bold text-white z-10">Personalized Study Path</span>
          </div>
        </div>
      </div>

      <div class="max-w-7xl mx-auto mt-20 lg:mt-32 p-4 bg-white bg-opacity-10 rounded-2xl shadow-inner">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
          <div>
            <h2 class="text-3xl font-bold text-white">Curated Subject Libraries</h2>
            <p class="mt-3 text-gray-200">Direct access to curated resources for core subjects.</p>
            <button onclick="changeView('login')" class="btn-primary text-white font-semibold mt-4 py-2 px-6 rounded-lg text-sm shadow">View Subjects</button>
          </div>
          <div>
            <h2 class="text-3xl font-bold text-white">Track Your Progress</h2>
            <p class="mt-3 text-gray-200">See your streak, points and completion rates.</p>
            <p class="mt-2 text-sm text-yellow-300">(See the dashboard after login!)</p>
          </div>
        </div>
      </div>
    </section>

    <!-- LOGIN -->
    <section id="view-login" data-view="login" class="landing-gradient min-h-screen flex items-center justify-center p-4 hidden">
      <div id="auth-card" class="bg-white rounded-3xl shadow-2xl p-6 sm:p-10 w-full max-w-md">
        <h2 class="text-3xl font-extrabold text-gray-900 text-center">EDUSTARHUB Portal</h2>
        <p class="mt-2 mb-8 text-center text-gray-500">Access your personalised GCSE learning journey.</p>

        <div class="border-b mb-6 pb-4">
          <div class="flex bg-gray-100 rounded-xl p-1">
            <button id="tab-student" data-role="student" onclick="setAuthRole('student')" class="flex-1 py-3 text-center text-sm font-semibold rounded-lg bg-violet-600 text-white">Student Login</button>
            <button id="tab-teacher" data-role="teacher" onclick="setAuthRole('teacher')" class="flex-1 py-3 text-center text-sm font-semibold rounded-lg text-gray-600 hover:text-violet-600">Teacher Login</button>
          </div>
        </div>

        <form id="login-form">
          <div class="mb-5">
            <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
            <div class="mt-1 relative rounded-lg shadow-sm">
              <input type="text" id="username" name="username" placeholder="Enter specific username" required class="block w-full pl-3 pr-3 py-3 border border-gray-300 rounded-lg placeholder-gray-400 sm:text-sm"/>
            </div>
          </div>

          <div class="mb-8">
            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
            <div class="mt-1 relative rounded-lg shadow-sm">
              <input type="password" id="password" name="password" placeholder="••••••••" required class="block w-full pl-3 pr-3 py-3 border border-gray-300 rounded-lg placeholder-gray-400 sm:text-sm"/>
            </div>
          </div>

          <button type="submit" id="login-btn" class="w-full btn-primary text-white font-bold py-3 rounded-xl text-lg">Sign In as <span id="login-role-text">Student</span></button>
        </form>

        <p id="auth-error-message" class="mt-4 text-center text-sm text-red-600 hidden"></p>
        <p id="firebase-warning" class="mt-2 text-center text-sm text-yellow-600 hidden"></p>

        <p class="mt-6 text-center text-sm text-gray-500">Trouble logging in? <a href="#" class="font-medium text-violet-600 hover:text-violet-500">Contact support</a></p>
        <button onclick="changeView('landing')" class="mt-4 w-full text-sm text-violet-600 hover:text-violet-500">← Back to Home</button>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="view-dashboard" data-view="dashboard" class="min-h-screen p-4 lg:p-8 bg-dashboard-bg hidden">
      <header class="flex justify-between items-center bg-white p-4 rounded-xl shadow-lg mb-8 sticky top-0 z-10">
        <div class="text-2xl font-extrabold text-violet-700">EDUSTARHUB</div>
        <div class="flex items-center space-x-3">
          <span id="user-name" class="text-sm font-semibold text-gray-700"></span>
          <span id="user-role" class="text-xs font-medium text-white px-2 py-1 rounded-full bg-fuchsia-500"></span>
          <button id="logout-btn" class="text-sm text-gray-500 hover:text-red-600">Logout</button>
        </div>
      </header>

      <div id="dashboard-content" class="dashboard-grid max-w-7xl mx-auto">
        <div id="dashboard-sidebar" class="bg-white p-6 rounded-2xl shadow-xl space-y-8 h-full sticky top-[6.5rem]">
          <div id="student-nav-menu">
            <h3 class="text-lg font-bold text-violet-700 mb-4">Study Menu</h3>
            <nav id="sidebar-nav-student" class="space-y-2 text-base">
              <a href="#" onclick="handleNavClickStudent(this, 'dashboard')" data-nav="dashboard" class="flex items-center p-3 rounded-xl bg-violet-100 text-violet-700 font-bold">Dashboard</a>
              <a href="#" onclick="handleNavClickStudent(this, 'resources')" data-nav="resources" class="flex items-center p-3 rounded-xl text-gray-700 hover:bg-violet-50">Resources</a>
              <a href="#" onclick="handleNavClickStudent(this, 'quizzes')" data-nav="quizzes" class="flex items-center p-3 rounded-xl text-gray-700 hover:bg-violet-50">Quizzes / Exams</a>
            </nav>
          </div>

          <div id="teacher-nav-menu" class="hidden">
            <h3 class="text-lg font-bold text-violet-700 mb-4">Management</h3>
            <nav id="sidebar-nav-teacher" class="space-y-2 text-base">
              <a href="#" onclick="handleNavClickTeacher(this, 'resources')" data-nav="resources" class="flex items-center p-3 rounded-xl bg-violet-100 text-violet-700 font-bold">Resources</a>
              <a href="#" onclick="handleNavClickTeacher(this, 'assessments')" data-nav="assessments" class="flex items-center p-3 rounded-xl text-gray-700 hover:bg-violet-50">Quizzes / Exams</a>
            </nav>
          </div>

          <div id="student-progress-section" class="space-y-4 pt-4 border-t border-gray-100">
            <h3 class="text-lg font-bold text-gray-800">Your Progress</h3>
            <div class="space-y-2 text-sm">
              <div onclick="handleUnitClick('Cells','75%')" class="interactive-card p-3 bg-green-50 rounded-xl hover:bg-green-100">Unit 1: Cells (75%)</div>
              <div onclick="handleUnitClick('Forces','40%')" class="interactive-card p-3 bg-yellow-50 rounded-xl hover:bg-yellow-100">Unit 2: Forces (40%)</div>
              <div onclick="handleUnitClick('Energy','10%')" class="interactive-card p-3 bg-red-50 rounded-xl hover:bg-red-100">Unit 3: Energy (10%)</div>
            </div>
          </div>
        </div>

        <div id="main-dashboard-area">
          <h2 id="main-content-title" class="text-2xl font-extrabold text-gray-900 mb-6">Your Today's Tasks</h2>

          <!-- Student content container -->
          <div id="student-content-container">
            <div id="student-view-dashboard">
              <div class="grid grid-cols-1 gap-6">
                <div class="bg-violet-100 p-8 rounded-2xl shadow-xl col-span-full h-80">
                  <h3 class="text-3xl font-bold text-violet-800">AI Study Assistant</h3>
                  <div class="mt-8 flex gap-4">
                    <input type="text" id="ai-topic-input" placeholder="e.g., Explain the stages of Mitosis" class="flex-grow p-4 rounded-xl border border-violet-300"/>
                    <button onclick="explainTopic()" id="ai-explain-btn" class="bg-violet-500 text-white py-3 px-8 rounded-xl">✨ Explain Topic</button>
                  </div>
                </div>

                <div class="col-span-full mt-2">
                  <h3 class="text-xl font-bold text-gray-800 mb-4">Practice Quizzes/Exams (Recent)</h3>
                  <div id="dashboard-assessment-list" class="bg-white p-4 rounded-2xl shadow-xl space-y-3 max-h-52 custom-scroll overflow-y-auto">No assessments have been uploaded yet.</div>
                </div>

                <div class="col-span-full mt-2">
                  <h3 class="text-xl font-bold text-gray-800 mb-4">New Study Resources (Recent)</h3>
                  <div id="dashboard-resource-list" class="bg-white p-4 rounded-2xl shadow-xl space-y-3 max-h-52 custom-scroll overflow-y-auto">No resources have been uploaded yet.</div>
                </div>
              </div>
            </div>

            <div id="student-view-resources" class="hidden">
              <div id="full-resource-list" class="bg-white p-4 rounded-2xl shadow-xl custom-scroll overflow-y-auto">Loading all resources...</div>
            </div>

            <div id="student-view-quizzes" class="hidden">
              <div id="full-assessment-list" class="bg-white p-4 rounded-2xl shadow-xl custom-scroll overflow-y-auto">Loading all assessments...</div>
            </div>
          </div>

          <!-- Teacher upload forms -->
          <div id="teacher-resources-content" class="hidden">
            <div class="bg-white p-8 rounded-2xl shadow-xl space-y-6">
              <h3 class="text-xl font-bold">Upload New Study Resource (Files, Notes, Links)</h3>
              <form id="upload-resource-form" class="space-y-4">
                <div>
                  <label for="resource-title" class="block text-sm font-medium text-gray-700">Resource Title</label>
                  <input id="resource-title" type="text" required class="w-full p-3 border border-gray-300 rounded-lg"/>
                </div>
                <div>
                  <label for="resource-subject" class="block text-sm font-medium text-gray-700">Subject/Unit</label>
                  <select id="resource-subject" required class="w-full p-3 border border-gray-300 rounded-lg">
                    <option value="">Select a Subject</option><option value="Maths">Maths</option><option value="Science">Science</option><option value="English">English Language/Literature</option><option value="History">History</option>
                  </select>
                </div>
                <div>
                  <label for="resource-file" class="block text-sm font-medium text-gray-700">Select File to Upload</label>
                  <input id="resource-file" type="file" required class="w-full mt-1"/>
                </div>
                <div>
                  <label for="resource-description" class="block text-sm font-medium text-gray-700">Description</label>
                  <textarea id="resource-description" rows="3" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                </div>
                <button id="upload-resource-btn" type="submit" class="w-full btn-primary text-white py-3 rounded-xl">Upload Resource</button>
                <p id="upload-resource-status" class="mt-2 text-center text-sm text-green-600 hidden"></p>
              </form>
            </div>
          </div>

          <div id="teacher-assessments-content" class="hidden">
            <div class="bg-white p-8 rounded-2xl shadow-xl space-y-6">
              <h3 class="text-xl font-bold">Upload New Quiz / Exam Paper (Assessments)</h3>
              <form id="upload-assessment-form" class="space-y-4">
                <div>
                  <label for="assessment-title">Assessment Title</label>
                  <input id="assessment-title" type="text" required class="w-full p-3 border border-gray-300 rounded-lg"/>
                </div>
                <div>
                  <label for="assessment-subject">Subject/Unit</label>
                  <select id="assessment-subject" required class="w-full p-3 border border-gray-300 rounded-lg">
                    <option value="">Select a Subject</option><option>Maths</option><option>Science</option><option>English</option><option>History</option>
                  </select>
                </div>
                <div>
                  <label for="assessment-file">Select Quiz/Exam File</label>
                  <input id="assessment-file" type="file" required class="w-full mt-1"/>
                </div>
                <div>
                  <label for="assessment-description">Instructions/Description</label>
                  <textarea id="assessment-description" rows="3" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                </div>
                <button id="upload-assessment-btn" type="submit" class="w-full bg-fuchsia-500 text-white py-3 rounded-xl">Publish Assessment</button>
                <p id="upload-assessment-status" class="mt-2 text-center text-sm text-green-600 hidden"></p>
              </form>
            </div>
          </div>

        </div>
      </div>
    </section>
  </div>

  <!-- App script: localStorage based, no Firebase -->
  <script>
    // --- HARDCODED CREDENTIALS ---
    const CREDENTIALS = {
      student: { username: 'EDU-Star1', password: 'EDU-Star1', displayName: 'GCSE Student' },
      teacher: { username: 'EDU-Admin4', password: 'EDU-Admin4', displayName: 'Admin Teacher' }
    };

    // Local storage keys
    const SESSION_KEY = 'edustar_user';
    const RESOURCES_KEY = 'edustarhub_resources';

    // GLOBAL STATE
    let userRole = 'student';
    let currentUser = null;
    let resourcesCache = [];

    // UTILS
    function showLoading(show) {
      const o = document.getElementById('loading-overlay'); if (!o) return;
      show ? o.classList.remove('hidden') : o.classList.add('hidden');
    }
    function showMessage(msg) {
      console.log('APP MESSAGE:', msg); window.alert(msg);
    }
    function changeView(viewId) {
      document.querySelectorAll('[data-view]').forEach(v => v.classList.add('hidden'));
      document.getElementById('view-' + viewId).classList.remove('hidden');
    }

    // SESSION helpers
    function setLocalSession(role, username, displayName) {
      const session = { role, username, displayName, loggedAt: new Date().toISOString() };
      try { localStorage.setItem(SESSION_KEY, JSON.stringify(session)); } catch (e) { console.warn('localStorage set session failed', e); }
    }
    function getLocalSession() {
      try { const raw = localStorage.getItem(SESSION_KEY); return raw ? JSON.parse(raw) : null; } catch (e) { console.warn(e); return null; }
    }
    function clearLocalSession() { try { localStorage.removeItem(SESSION_KEY); } catch (e) { console.warn(e); } }

    // Resources helpers (localStorage)
    function getResourcesFromStorage() {
      try {
        const raw = localStorage.getItem(RESOURCES_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.warn('Failed to read resources from localStorage', e);
        return [];
      }
    }
    function saveResourcesToStorage(resources) {
      try { localStorage.setItem(RESOURCES_KEY, JSON.stringify(resources)); } catch (e) { console.warn('Failed to write resources to localStorage', e); }
    }
    function loadCachedResources() {
      resourcesCache = getResourcesFromStorage() || [];
    }

    // Format date helper
    function formatDate(value) {
      if (!value) return 'Unknown';
      try { return new Date(value).toLocaleString(); } catch (e) { return String(value); }
    }

    // Create resource card (click opens data URL in new tab)
    function createResourceCard(resource) {
      const item = document.createElement('div');
      item.className = 'flex items-start p-3 border border-gray-100 rounded-xl hover:bg-gray-50 transition duration-150 interactive-card';

      const iconPath = resource.type === 'assessment' ? 'M9 12h6m-6 4h6' : 'M12 6.253v13';
      const bgColor = resource.type === 'assessment' ? 'bg-fuchsia-100' : 'bg-violet-100';
      const textColor = resource.type === 'assessment' ? 'text-fuchsia-700' : 'text-violet-700';
      const itemType = resource.type === 'assessment' ? 'Assessment' : 'Resource';

      const left = document.createElement('div');
      left.className = `p-3 ${bgColor} ${textColor} rounded-xl mr-4 flex-shrink-0`;
      left.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path></svg>`;

      const body = document.createElement('div');
      body.className = 'flex-grow';
      body.innerHTML = `<span class="text-lg font-semibold text-gray-900">${resource.title}</span>
          <p class="text-sm text-gray-600">${resource.description}</p>
          <p class="text-xs text-gray-400 mt-1">Type: <span class="font-medium ${textColor}">${itemType}</span> | Subject: ${resource.subject} | Uploaded: ${formatDate(resource.uploadedAt)}</p>`;

      if (resource.fileUrl) {
        item.addEventListener('click', () => window.open(resource.fileUrl));
      } else {
        item.addEventListener('click', () => showMessage(`You clicked the ${itemType}: ${resource.title}, but file URL is not available.`));
      }

      item.appendChild(left);
      item.appendChild(body);
      return item;
    }

    function renderList(contentArray, containerId) {
      const containerEl = document.getElementById(containerId);
      containerEl.innerHTML = '';
      if (!contentArray || contentArray.length === 0) {
        const msg = containerId.includes('assessment') ? 'No quizzes or exams have been uploaded yet.' :
                    containerId.includes('resource') ? 'No study resources have been uploaded yet.' : 'No content available.';
        containerEl.innerHTML = `<p class="text-gray-500 text-center py-6">${msg}</p>`;
      } else {
        contentArray.forEach(r => containerEl.appendChild(createResourceCard(r)));
      }
    }

    // Load content lists from local cache
    async function loadContentLists(viewKey) {
      showLoading(true);
      try {
        loadCachedResources();
        const studyResources = resourcesCache.filter(r => r.type === 'resource');
        const assessments = resourcesCache.filter(r => r.type === 'assessment');

        if (viewKey === 'dashboard') {
          renderList(assessments.slice(0,3), 'dashboard-assessment-list');
          renderList(studyResources.slice(0,3), 'dashboard-resource-list');
        } else if (viewKey === 'resources') {
          renderList(studyResources, 'full-resource-list');
        } else if (viewKey === 'assessments') {
          renderList(assessments, 'full-assessment-list');
        }
      } catch (err) {
        console.error('Error loading content lists (local):', err);
        renderList([], 'dashboard-assessment-list'); renderList([], 'dashboard-resource-list'); renderList([], 'full-resource-list'); renderList([], 'full-assessment-list');
      } finally { showLoading(false); }
    }

    // Upload handler: read file as DataURL and store locally in resources
    async function handleUpload(e, type) {
      e.preventDefault();
      const titleId = type === 'resource' ? 'resource-title' : 'assessment-title';
      const subjectId = type === 'resource' ? 'resource-subject' : 'assessment-subject';
      const descriptionId = type === 'resource' ? 'resource-description' : 'assessment-description';
      const fileId = type === 'resource' ? 'resource-file' : 'assessment-file';
      const btnId = type === 'resource' ? 'upload-resource-btn' : 'upload-assessment-btn';
      const statusId = type === 'resource' ? 'upload-resource-status' : 'upload-assessment-status';

      const uploadBtn = document.getElementById(btnId);
      const statusMsg = document.getElementById(statusId);
      uploadBtn.disabled = true; statusMsg.classList.add('hidden');

      try {
        const title = document.getElementById(titleId).value;
        const subject = document.getElementById(subjectId).value;
        const description = document.getElementById(descriptionId).value;
        const fileInput = document.getElementById(fileId);
        const file = fileInput.files[0];

        if (!file) throw new Error(`Please select a file to upload for the ${type}.`);

        // Read file as DataURL (base64) using FileReader
        const fileDataUrl = await new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result);
          fr.onerror = () => reject(new Error('Failed to read file'));
          fr.readAsDataURL(file);
        });

        const newResource = {
          id: `local-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,
          type,
          title,
          subject,
          description,
          fileName: file.name,
          fileType: file.type,
          fileSize: file.size,
          fileUrl: fileDataUrl, // base64 data URL
          uploadedAt: new Date().toISOString(),
          uploaderRole: userRole,
          uploaderId: (currentUser && currentUser.uid) ? currentUser.uid : `local-${userRole}`
        };

        // Save to local storage resources
        loadCachedResources();
        resourcesCache.unshift(newResource); // newest first
        saveResourcesToStorage(resourcesCache);

        statusMsg.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} '${file.name}' uploaded successfully!`;
        statusMsg.classList.remove('hidden'); statusMsg.classList.remove('text-red-600'); statusMsg.classList.add('text-green-600');

        // Reset form
        document.getElementById(`upload-${type}-form`).reset();

        // Refresh lists
        await loadContentLists('dashboard');
      } catch (err) {
        console.error('Upload failed:', err);
        statusMsg.textContent = `Upload failed: ${err.message}`;
        statusMsg.classList.remove('hidden'); statusMsg.classList.add('text-red-600');
      } finally {
        uploadBtn.disabled = false;
      }
    }

    // Login using local credentials & localStorage session (no Firebase)
    async function handleSubmitLogin(e) {
      e.preventDefault();
      const usernameInput = document.getElementById('username') ? document.getElementById('username').value.trim() : '';
      const passwordInput = document.getElementById('password') ? document.getElementById('password').value : '';
      const errorMsg = document.getElementById('auth-error-message');
      errorMsg.classList.add('hidden');
      showLoading(true);

      const requiredCreds = CREDENTIALS[userRole];
      let isAuthenticated = false;
      let displayName = 'User';

      if (requiredCreds) {
        if (usernameInput === requiredCreds.username && passwordInput === requiredCreds.password) {
          isAuthenticated = true;
          displayName = requiredCreds.displayName;
        }
      }

      if (!isAuthenticated) {
        errorMsg.textContent = `Invalid credentials for ${userRole}. Please use the specific ${userRole} username and password.`;
        errorMsg.classList.remove('hidden');
        showLoading(false);
        return;
      }

      // Save local session - persists across reloads
      setLocalSession(userRole, usernameInput, displayName);

      // Set local currentUser placeholder
      currentUser = { uid: `local-${userRole}-${Date.now()}`, displayName, isLocal: true };

      // Set up UI & load lists
      setupDashboard(userRole, displayName);
      changeView('dashboard');
      await loadContentLists('dashboard');

      showLoading(false);
    }

    // Logout - clear local session
    async function handleLogout() {
      showLoading(true);
      clearLocalSession();
      userRole = 'student';
      currentUser = null;
      changeView('landing');
      showLoading(false);
    }

    function setAuthRole(role) {
      userRole = role;
      document.querySelectorAll('#auth-card button[data-role]').forEach(btn => btn.classList.remove('bg-violet-600', 'text-white', 'shadow-md'));
      document.querySelectorAll('#auth-card button[data-role]').forEach(btn => btn.classList.add('text-gray-600', 'hover:text-violet-600'));
      document.getElementById(`tab-${role}`).classList.add('bg-violet-600', 'text-white', 'shadow-md');
      document.getElementById('login-role-text').textContent = role.charAt(0).toUpperCase() + role.slice(1);
    }

    // Setup UI on login
    function setupDashboard(role, userName) {
      document.getElementById('user-name').textContent = userName;
      document.getElementById('user-role').textContent = role.toUpperCase();

      const isStudent = role === 'student';
      document.getElementById('student-content-container').classList.toggle('hidden', !isStudent);
      document.getElementById('student-nav-menu').classList.toggle('hidden', !isStudent);
      document.getElementById('teacher-nav-menu').classList.toggle('hidden', isStudent);
      document.getElementById('teacher-sidebar-info').classList.toggle('hidden', isStudent);
      // Teacher UI hide/display for upload sections
      document.getElementById('teacher-resources-content').classList.toggle('hidden', isStudent);
      document.getElementById('teacher-assessments-content').classList.toggle('hidden', isStudent);

      if (isStudent) {
        const defaultStudentNav = document.querySelector('#sidebar-nav-student a[data-nav="dashboard"]'); if (defaultStudentNav) defaultStudentNav.click();
      } else {
        document.getElementById('main-content-title').textContent = "Resource Management Center";
        const defaultTeacherNav = document.querySelector('#sidebar-nav-teacher a[data-nav="resources"]');
        if (defaultTeacherNav) handleNavClickTeacher(defaultTeacherNav, 'resources');
      }
    }

    function handleNavClickStudent(el, viewKey) {
      document.querySelectorAll('#sidebar-nav-student a').forEach(item => item.classList.remove('bg-violet-100', 'text-violet-700', 'font-bold'));
      document.querySelectorAll('#sidebar-nav-student a').forEach(item => item.classList.add('text-gray-700', 'hover:bg-violet-50'));
      el.classList.add('bg-violet-100', 'text-violet-700', 'font-bold');
      el.classList.remove('text-gray-700', 'hover:bg-violet-50');
      renderStudentView(viewKey);
    }
    function handleNavClickTeacher(el, navKey) {
      document.querySelectorAll('#sidebar-nav-teacher a').forEach(item => item.classList.remove('bg-violet-100', 'text-violet-700', 'font-bold'));
      document.querySelectorAll('#sidebar-nav-teacher a').forEach(item => item.classList.add('text-gray-700', 'hover:bg-violet-50'));
      el.classList.add('bg-violet-100', 'text-violet-700', 'font-bold');
      el.classList.remove('text-gray-700', 'hover:bg-violet-50');
      renderTeacherContent(navKey);
    }

    function renderStudentView(viewKey) {
      const views = { dashboard: document.getElementById('student-view-dashboard'), resources: document.getElementById('student-view-resources'), quizzes: document.getElementById('student-view-quizzes') };
      Object.values(views).forEach(v => v.classList.add('hidden'));
      if (views[viewKey]) views[viewKey].classList.remove('hidden');
      const titleEl = document.getElementById('main-content-title');
      if (viewKey === 'dashboard') { titleEl.textContent = 'Your Study Dashboard'; loadContentLists('dashboard'); }
      else if (viewKey === 'resources') { titleEl.textContent = 'Full Resources Library'; loadContentLists('resources'); }
      else { titleEl.textContent = 'All Quizzes and Exams'; loadContentLists('assessments'); }
    }

    function renderTeacherContent(navKey) {
      const titleEl = document.getElementById('main-content-title');
      const resourcesContent = document.getElementById('teacher-resources-content');
      const assessmentsContent = document.getElementById('teacher-assessments-content');
      resourcesContent.classList.add('hidden'); assessmentsContent.classList.add('hidden');
      if (navKey === 'resources') { titleEl.textContent = 'Upload New Study Resources'; resourcesContent.classList.remove('hidden'); }
      else if (navKey === 'assessments') { titleEl.textContent = 'Upload New Quizzes & Exams'; assessmentsContent.classList.remove('hidden'); }
    }

    // Load session & attach event listeners on start
    document.addEventListener('DOMContentLoaded', async () => {
      setAuthRole('student');
      changeView('landing');

      document.getElementById('login-form').addEventListener('submit', handleSubmitLogin);
      document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
      document.getElementById('upload-resource-form').addEventListener('submit', (e) => handleUpload(e, 'resource'));
      document.getElementById('upload-assessment-form').addEventListener('submit', (e) => handleUpload(e, 'assessment'));

      // restore session if local
      const session = getLocalSession();
      if (session && session.role) {
        userRole = session.role;
        setAuthRole(userRole);
        currentUser = { uid: `local-${userRole}-${Date.now()}`, displayName: session.displayName || (CREDENTIALS[userRole] && CREDENTIALS[userRole].displayName) };
        setupDashboard(userRole, currentUser.displayName);
        changeView('dashboard');
        await loadContentLists('dashboard');
      } else {
        changeView('landing');
      }
    });

  </script>
</body>
</html>
